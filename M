<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مشروعي الذكي - Offline AI</title>
    <link rel="manifest" href="manifest.json">
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        header { background: var(--primary); color: white; width: 100%; padding: 1rem; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .container { max-width: 800px; width: 90%; background: white; margin: 20px; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        #chat-window { height: 300px; overflow-y: auto; border: 1px solid #e2e8f0; padding: 10px; margin-bottom: 15px; border-radius: 8px; display: flex; flex-direction: column; }
        .msg { margin: 5px 0; padding: 8px 12px; border-radius: 15px; max-width: 80%; }
        .user-msg { background: var(--primary); color: white; align-self: flex-end; }
        .ai-msg { background: #e2e8f0; color: #1e293b; align-self: flex-start; }
        #status { font-size: 0.85rem; margin-bottom: 10px; color: #64748b; }
        input { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; box-sizing: border-box; }
        .buttons { margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap; }
        button { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-send { background: var(--primary); color: white; }
        .btn-download { background: #10b981; color: white; }
        button:disabled { background: #94a3b8; cursor: not-allowed; }
    </style>
</head>
<body>

<header>
    <h1>منصة الذكاء الاصطناعي الخاص بي</h1>
</header>

<div class="container">
    <div id="status">جاري فحص حالة النظام...</div>
    <div id="chat-window">
        <div class="msg ai-msg">مرحباً! أنا أعمل داخل متصفحك الآن. بمجرد اكتمال تحميل النموذج، يمكنك سؤالي عن أي شيء بالإنجليزية حتى لو فصلت الإنترنت.</div>
    </div>
    
    <input type="text" id="userInput" placeholder="اسألني شيئاً بالإنجليزية..." disabled>
    
    <div class="buttons">
        <button onclick="askAI()" id="sendBtn" class="btn-send" disabled>إرسال</button>
        <button onclick="downloadProject()" class="btn-download">⬇️ تحميل أكواد المشروع لرفعها على GitHub</button>
    </div>
</div>

<script type="module">
    // استيراد مكتبة الذكاء الاصطناعي
    import { pipeline } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2';

    let generator;
    const statusTxt = document.getElementById('status');
    const inputField = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');
    const chatWindow = document.getElementById('chat-window');

    // تهيئة الذكاء الاصطناعي
    async function initAI() {
        try {
            statusTxt.textContent = "جاري تحميل نموذج AI (مرة واحدة فقط)...";
            generator = await pipeline('text-generation', 'Xenova/gpt2');
            statusTxt.textContent = "✅ النظام جاهز ويعمل بدون إنترنت!";
            inputField.disabled = false;
            sendBtn.disabled = false;
        } catch (e) {
            statusTxt.textContent = "خطأ في التحميل. تأكد من اتصالك بالإنترنت في المرة الأولى.";
        }
    }

    window.askAI = async () => {
        const text = inputField.value;
        if(!text) return;

        addMessage(text, 'user-msg');
        inputField.value = '';
        statusTxt.textContent = "يفكر...";

        const output = await generator(text, { max_new_tokens: 50, temperature: 0.7 });
        addMessage(output[0].generated_text, 'ai-msg');
        statusTxt.textContent = "جاهز";
    }

    function addMessage(txt, className) {
        const div = document.createElement('div');
        div.className = `msg ${className}`;
        div.textContent = txt;
        chatWindow.appendChild(div);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    // تسجيل الـ Service Worker للعمل بدون إنترنت
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js').catch(() => console.log("Offline mode setup"));
    }

    initAI();

    // دالة تحميل الأكواد للمستخدم
    window.downloadProject = () => {
        const files = {
            'sw.js': `const CACHE_NAME = 'ai-offline-v1';
self.addEventListener('install', e => {
  e.waitUntil(caches.open(CACHE_NAME).then(c => c.addAll(['./', './index.html'])));
});
self.addEventListener('fetch', e => {
  e.respondWith(caches.match(e.request).then(r => r || fetch(e.request)));
});`,
            'manifest.json': `{
  "name": "My Offline AI",
  "short_name": "OfflineAI",
  "start_url": "./index.html",
  "display": "standalone",
  "background_color": "#ffffff",
  "theme_color": "#2563eb",
  "icons": [{"src": "https://cdn-icons-png.flaticon.com/512/2593/2593635.png", "sizes": "512x512", "type": "image/png"}]
}`
        };

        for (const [name, content] of Object.entries(files)) {
            const blob = new Blob([content], { type: 'text/plain' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = name;
            link.click();
        }
        alert("تم تحميل ملفات (sw.js) و (manifest.json). تأكد من وضعهما في نفس مجلد ملف index.html على GitHub.");
    };
</script>

</body>
</html>
